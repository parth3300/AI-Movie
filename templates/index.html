<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üé¨ AI Movie Processor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f7f7f7; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; border: none; background: #4CAF50; color: white; border-radius: 6px; }
    button:hover { background: #45a049; }
    textarea { width: 100%; height: 140px; margin-top: 10px; font-size: 15px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    #response { margin-top: 20px; background: #fff; padding: 15px; border-radius: 6px; }
    .download-link { display: block; margin: 8px 0; padding: 10px; background: #4CAF50; color: white; text-decoration: none; border-radius: 5px; text-align: center; }
  </style>
</head>
<body>
  <h1>üé¨ AI Movie Processor</h1>

  <button id="generateSRT">Generate SRT Files</button>

  <hr>
  <label>Transcript Text (for trimming):</label>
  <textarea id="transcriptText" placeholder="00:00:02,000&#10;00:00:10,000&#10;00:00:15,000&#10;00:00:25,000"></textarea>
  <button id="trimVideo">Trim Video</button>

  <div id="response">Server response will appear here...</div>

  <script>
    const responseDiv = document.getElementById("response");

    // üß© Generate SRT parts
    document.getElementById("generateSRT").addEventListener("click", async () => {
      responseDiv.innerText = "‚è≥ Generating SRT files from Colab...";
      try {
        const res = await axios.post("/generate_srt");
        const data = res.data;

        if (data.error) {
          responseDiv.innerText = "Error: " + data.error;
          return;
        }

        responseDiv.innerHTML = "<h3>‚úÖ SRT Parts Generated:</h3>";
        data.files.forEach((fileUrl, i) => {
          const a = document.createElement("a");
          a.href = fileUrl;
          a.className = "download-link";
          a.textContent = `Download SRT Part ${i + 1}`;
          responseDiv.appendChild(a);
        });
      } catch (err) {
        responseDiv.innerText = "Error: " + (err.response?.data?.error || err.message);
      }
    });

  function logMessage(message, type = "info") {
    const p = document.createElement("p");
    p.textContent = message;
    if (type === "success") p.style.color = "green";
    if (type === "error") p.style.color = "red";
    if (type === "warn") p.style.color = "orange";
    if (type === "title") {
      p.style.fontWeight = "bold";
      p.style.marginTop = "10px";
    }
    responseDiv.appendChild(p);
    responseDiv.scrollTop = responseDiv.scrollHeight; // auto-scroll to bottom
  }

  // ‚úÇÔ∏è Trim video with retry mechanism (4 timestamps per group)
  document.getElementById("trimVideo").addEventListener("click", async () => {
    const transcript = document.getElementById("transcriptText").value.trim();
    if (!transcript) {
      responseDiv.innerText = "‚ö†Ô∏è Please enter transcript timestamps first!";
      return;
    }

    const timestamps = transcript.split("\n").filter(line => line.trim() !== "");
    if (timestamps.length === 0) {
      responseDiv.innerText = "‚ö†Ô∏è No valid timestamps found!";
      return;
    }

    responseDiv.innerHTML = "‚è≥ Processing clips one by one (4 lines per group)...<br>";

    const totalGroups = Math.ceil(timestamps.length / 4);

    for (let i = 0; i < timestamps.length; i += 4) {
      const group = timestamps.slice(i, i + 4).join("\n");
      const groupNum = Math.floor(i / 4) + 1;
      let success = false;

      logMessage(`üé¨ Processing clip group ${groupNum} / ${totalGroups}...`, "title");

      for (let attempt = 1; attempt <= 3; attempt++) {
        try {
          logMessage(`‚û°Ô∏è Attempt ${attempt} for group ${groupNum}...`);

          const res = await axios.post("/trim", { transcript_text: group }, { responseType: "blob" });

          // üß© Create download link for each successful clip
          const url = window.URL.createObjectURL(new Blob([res.data]));
          const a = document.createElement("a");
          a.href = url;
          a.download = `clip_group_${groupNum}.mp4`;
          a.style.display = "none";
          document.body.appendChild(a);
          a.click();
          a.remove();

          logMessage(`‚úÖ Group ${groupNum} downloaded successfully on attempt ${attempt}`, "success");
          success = true;
          break;
        } catch (err) {
          logMessage(`‚ö†Ô∏è Attempt ${attempt} failed for group ${groupNum}: ${err.message}`, "warn");
          if (attempt < 3) {
            logMessage(`üîÅ Retrying group ${groupNum}...`);
          } else {
            logMessage(`‚ùå Failed to process group ${groupNum} after 3 attempts.`, "error");
          }
        }

        // Force UI refresh after each iteration
        await new Promise(resolve => setTimeout(resolve, 300));
      }

      if (!success) {
        logMessage(`üö´ Skipping group ${groupNum} due to repeated failures.`, "error");
      }

      logMessage(`-------------------------------`);
    }

    logMessage(`üéâ All ${totalGroups} clip groups processed and downloaded!`, "success");
  });
  </script>
</body>
</html>

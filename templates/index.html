<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üé¨ AI Movie Processor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f7f7f7; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
    textarea { width: 100%; height: 120px; margin-top: 10px; }
    #response { margin-top: 20px; background: #fff; padding: 10px; border-radius: 5px; }
    .download-link { display: block; margin: 8px 0; padding: 10px; background: #4CAF50; color: white; text-decoration: none; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>üé¨ AI Movie Processor</h1>

  <button id="generateSRT">Generate SRT Files</button>

  <hr>
  <label>Transcript Text (for trimming):</label>
  <textarea id="transcriptText" placeholder="00:00:02,000&#10;00:00:10,000"></textarea>
  <button id="trimVideo">Trim Video</button>

  <div id="response">Server response will appear here...</div>

  <script>
    const responseDiv = document.getElementById("response");

    // üß© Generate SRT parts
    document.getElementById("generateSRT").addEventListener("click", async () => {
      responseDiv.innerText = "‚è≥ Generating SRT files from Colab...";
      try {
        const res = await axios.post("/generate_srt");
        const data = res.data;

        if (data.error) {
          responseDiv.innerText = "Error: " + data.error;
          return;
        }

        responseDiv.innerHTML = "<h3>‚úÖ SRT Parts Generated:</h3>";
        data.files.forEach((fileUrl, i) => {
          const a = document.createElement("a");
          a.href = fileUrl;
          a.className = "download-link";
          a.textContent = `Download SRT Part ${i + 1}`;
          responseDiv.appendChild(a);
        });
      } catch (err) {
        responseDiv.innerText = "Error: " + (err.response?.data?.error || err.message);
      }
    });

    // ‚úÇÔ∏è Trim video with retry mechanism
    document.getElementById("trimVideo").addEventListener("click", async () => {
      const transcript = document.getElementById("transcriptText").value.trim();
      if (!transcript) {
        responseDiv.innerText = "‚ö†Ô∏è Please enter transcript timestamps first!";
        return;
      }

      const timestamps = transcript.split("\n").filter(line => line.trim() !== "");
      if (timestamps.length === 0) {
        responseDiv.innerText = "‚ö†Ô∏è No valid timestamps found!";
        return;
      }

      responseDiv.innerHTML = "‚è≥ Processing clips one by one...<br>";

      for (let i = 0; i < timestamps.length; i += 2) {
        const pair = timestamps.slice(i, i + 2).join("\n");
        const groupNum = Math.floor(i / 2) + 1;
        let success = false;

        for (let attempt = 1; attempt <= 3; attempt++) {
          try {
            responseDiv.innerHTML += `‚û°Ô∏è Processing clip group ${groupNum} / ${timestamps.length/2} (Attempt ${attempt})...<br>`;
            
            const res = await axios.post(
              "/trim",
              { transcript_text: pair },
              { responseType: "blob" }
            );

            // üß© Create download link for each successful clip
            const url = window.URL.createObjectURL(new Blob([res.data]));
            const a = document.createElement("a");
            a.href = url;
            a.download = `clip_group_${groupNum}.mp4`;
            document.body.appendChild(a);
            a.click();
            a.remove();

            responseDiv.innerHTML += `‚úÖ Downloaded clip group ${groupNum} successfully on attempt ${attempt}<br>`;
            success = true;
            break;
          } catch (err) {
            responseDiv.innerHTML += `‚ö†Ô∏è Attempt ${attempt} failed for group ${groupNum}: ${err.message}<br>`;
            if (attempt < 3) {
              responseDiv.innerHTML += `üîÅ Retrying group ${groupNum}...<br>`;
            } else {
              responseDiv.innerHTML += `‚ùå Failed to process group ${groupNum} after 3 attempts.<br>`;
            }
          }
        }

        if (!success) {
          responseDiv.innerHTML += `üö´ Skipping group ${groupNum} due to repeated failures.<br>`;
        }
      }

      responseDiv.innerHTML += "<h3>üéâ All clips processed and downloaded (with retries)!</h3>";
    });
  </script>
</body>
</html>
